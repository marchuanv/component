function Factory(){const o={};Object.defineProperty(this,"createContainer",{configurable:!1,writable:!1,value:({scopeId:e,type:s,variableName:n,singleton:t})=>{t=t?"global":e;if(!t)throw new Error("Factory: no scopeId provided.");o[t]||(o[t]=[]);const r=o[t],a={references:{},Id:utils.generateGUID(),type:s,name:n,scopeId:t,config:e=>{var t=e.references||e;for(const s of Object.keys(t))a.references[s]=t[s]},ensureInstance:()=>{if(a.references[n])return a.references[n];const e={scopeId:a.scopeId};for(const t of Object.keys(a.references))e[t]=a.references[t];a.references[n]=new s(e)}};return r.push(a),a}}),Object.defineProperty(this,"getContainer",{configurable:!1,writable:!1,value:({scopeId:e,type:t,variableName:s,singleton:n})=>{n=n?"global":e;if(n)return o[n]?o[n].find(e=>e.name===s&&e.type.name===t.name):null;throw new Error("Factory: no scopeId provided.")}})}function ClientMessageBus({httpClientRequestMessageBus:t,httpClientResponseMessageBus:e,messageConverter:s}){Object.defineProperty(this,"publish",{configurable:!1,writable:!1,value:async({message:e})=>{await t.publish(s.convertMessageToHttpRequestMessage({message:e}))}}),Object.defineProperty(this,"subscribe",{configurable:!1,writable:!1,value:({callback:t})=>{e.subscribe({callback:async({httpResponseMessage:e})=>{await t(s.convertHttpResponseMessageToMessage({httpResponseMessage:e}))}})}})}function Component({scopeId:n,clientMessageBus:r,serverMessageBus:a,userSessions:o,packageJson:e}){const{senderHost:i,senderPort:c,recipientHost:u,recipientPort:g,userId:p,timeout:d,isServerComponent:l}=e;Object.defineProperty(this,"initialise",{configurable:!1,writable:!1,value:async({secret:e})=>{const t=o.ensureSession({userId:p})["userSecurity"],s=(t.register({secret:e}),t.authenticate({secret:e}))["token"];l?(createHttpServerMessageBus({scopeId:n,timeout:d,senderHost:i,senderPort:c}),createHttpServerMessageBusManager({scopeId:n}),Object.defineProperty(this,"receive",{configurable:!1,writable:!1,value:async({callback:e})=>{await a.subscribe({callback:e})}}),Object.defineProperty(this,"send",{configurable:!1,writable:!1,value:async e=>{await a.publish(createMessage({scopeId:utils.generateGUID(),messageStatusCode:0,Id:null,data:e,recipientHost:u,recipientPort:g,metadata:{},token:s,senderHost:i,senderPort:c}))}})):(createHttpClientMessageBus({scopeId:n,timeout:d}),createHttpClientMessageBusManager({scopeId:n}),Object.defineProperty(this,"receive",{configurable:!1,writable:!1,value:async({callback:e})=>{await r.subscribe({callback:e})}}),Object.defineProperty(this,"send",{configurable:!1,writable:!1,value:async e=>{await r.publish(createMessage({scopeId:utils.generateGUID(),messageStatusCode:2,Id:null,data:e,recipientHost:u,recipientPort:g,metadata:{},token:s,senderHost:i,senderPort:c}))}}))}})}function ContentType({name:t}){var e=Object.values(types).findIndex(e=>e===t),e=0<Object.keys(types).findIndex(e=>e===t)?t:0<e?Object.keys(types)[e]:"unknown";Object.defineProperty(this,"name",{configurable:!1,writable:!1,value:e}),Object.defineProperty(this,"description",{configurable:!1,writable:!1,value:types[e]})}function Logger(){let o={},i=!1;Object.defineProperty(this,"log",{configurable:!1,writable:!1,value:({date:n,context:r,text:a})=>{return new Promise(t=>{const s=setInterval(()=>{if(!i){i=!0,o[r]||(o[r]=[]),o[r].push({date:n,text:a}),t(),o[r]=o[r].sort((e,t)=>new Date(e.date)-new Date(t.date));let e=o[r].shift();for(;e;){const{date:n,text:a}=e;console.log(n.toISOString()+`: ${r}, `+a),e=o[r].shift()}clearInterval(s),i=!1}},1e3)})}})}function Message({scopeId:s,Id:e,messageContent:t,messageContentMetadata:n,messageMetadata:r,messageStatus:a}){const o=e||utils.generateGUID();Object.defineProperty(this,"getId",{configurable:!1,writable:!1,value:()=>o}),Object.defineProperty(this,"getSenderAddress",{configurable:!1,writable:!1,value:()=>{var{senderhost:e,senderport:t}=r;return createSenderAddress({scopeId:s,senderHost:e,senderPort:t})}}),Object.defineProperty(this,"getRecipientAddress",{configurable:!1,writable:!1,value:()=>{var{recipienthost:e,recipientport:t}=r;return createRecipientAddress({scopeId:s,recipientHost:e,recipientPort:t})}}),Object.defineProperty(this,"getEncryptedContent",{configurable:!1,writable:!1,value:()=>t.encryptedData}),Object.defineProperty(this,"getDecryptedContent",{configurable:!1,writable:!1,value:()=>t.decryptedData}),Object.defineProperty(this,"getMessageMetadata",{configurable:!1,writable:!1,value:()=>r}),Object.defineProperty(this,"getContentMetadata",{configurable:!1,writable:!1,value:()=>n}),Object.defineProperty(this,"getMessageStatus",{configurable:!1,writable:!1,value:()=>a.root()})}function MessageContent({data:t,userSessions:s,messageMetadata:e,messageContentMetadata:n}){var e=e["token"],r=utils.getJSONObject(utils.base64ToString(e))["userId"];const a=s.ensureSession({userId:r})["userSecurity"];let o=null,i=null;if(a.isAuthorised({token:e})){var{contentType:s,isEncrypted:e}=n;if(e&&"base64Text"===s.name)o=a.decryptJSONToObject({encryptedJsonStr:t.replace("Encrypted:","")}),i=t;else{let e=null;"string"==typeof t&&"txt"===s.name&&(e={text:t}),i=a.encryptObjectToJSON({object:e}),o=a.decryptJSONToObject({encryptedJsonStr:i}),i="Encrypted:"+i,n.setContentType({name:"txt"}),n.setContentLength({length:Buffer.byteLength(i)})}}else o=`unable to decrypt message content, '${r}' user is not authorised.`,i=`unable to encrypt message content, '${r}' user is not authorised.`;Object.defineProperty(this,"encryptedData",{configurable:!1,writable:!1,value:i}),Object.defineProperty(this,"decryptedData",{configurable:!1,writable:!1,value:o})}function MessageContentMetadata({scopeId:t,data:e}){let s=!1,n=null,r=utils.getJSONObject(e)||e,a=("object"==typeof r?(n="json",r=utils.getJSONString(r)):"string"==typeof r&&(n="txt",s=e.startsWith("Encrypted:"),utils.isBase64String(e.replace("Encrypted:",""))&&(n="base64Text")),createContentType({scopeId:t,name:n}))["contentType"],o=Buffer.byteLength(r);Object.defineProperty(this,"contentType",{configurable:!1,get:()=>a}),Object.defineProperty(this,"contentLength",{configurable:!1,get:()=>o}),Object.defineProperty(this,"isEncrypted",{configurable:!1,writable:!1,value:s}),Object.defineProperty(this,"setContentLength",{configurable:!1,writable:!1,value:({length:e})=>o=e}),Object.defineProperty(this,"setContentType",{configurable:!1,writable:!1,value:({name:e})=>a=createContentType({scopeId:t,name:e})})}function MessageConverter(){Object.defineProperty(this,"convertMessageToHttpRequestMessage",{configurable:!1,writable:!1,value:({message:e})=>{var t=e.getId(),s=e.getEncryptedContent(),{senderHost:n,senderPort:r}=e.getSenderAddress(),{recipientHost:a,recipientPort:o}=e.getRecipientAddress(),i=e.getMessageMetadata(),c=i["token"],e=e.getMessageStatus()["code"];return createHttpRequestMessage({scopeId:utils.generateGUID(),messageStatusCode:e,Id:t,data:s,recipientHost:a,recipientPort:o,metadata:i,token:c,senderHost:n,senderPort:r})}}),Object.defineProperty(this,"convertMessageToHttpResponseMessage",{configurable:!1,writable:!1,value:({message:e})=>{var t=e.getMessageStatus()["code"],s=e.getId(),n=e.getEncryptedContent(),{recipientHost:r,recipientPort:a}=e.getRecipientAddress(),o=e.getMessageMetadata(),i=o["token"],{senderHost:e,senderPort:c}=e.getSenderAddress();return createHttpResponseMessage({scopeId:utils.generateGUID(),messageStatusCode:t,Id:s,data:n,recipientHost:r,recipientPort:a,metadata:o,token:i,senderHost:e,senderPort:c})}}),Object.defineProperty(this,"convertHttpRequestMessageToMessage",{configurable:!1,writable:!1,value:({httpRequestMessage:e})=>{var t=e.getMessageStatus()["code"],s=e.getId(),n=e.getEncryptedContent(),{recipientHost:r,recipientPort:a}=e.getRecipientAddress(),o=e.getMessageMetadata(),i=o["token"],{senderHost:e,senderPort:c}=e.getSenderAddress();return createMessage({scopeId:utils.generateGUID(),messageStatusCode:t,Id:s,data:n,recipientHost:r,recipientPort:a,metadata:o,token:i,senderHost:e,senderPort:c})}}),Object.defineProperty(this,"convertHttpResponseMessageToMessage",{configurable:!1,writable:!1,value:({httpResponseMessage:e})=>{var t=e.getMessageStatus()["code"],s=e.getId(),n=e.getEncryptedContent(),{recipientHost:r,recipientPort:a}=e.getRecipientAddress(),o=e.getMessageMetadata(),i=o["token"],{senderHost:e,senderPort:c}=e.getSenderAddress();return createMessage({scopeId:utils.generateGUID(),messageStatusCode:t,Id:s,data:n,recipientHost:r,recipientPort:a,metadata:o,token:i,senderHost:e,senderPort:c})}})}function MessageMetadata({metadata:e,token:t,senderAddress:s,recipientAddress:n}){Object.defineProperty(this,"create",{configurable:!1,writable:!1,value:({name:t,value:e})=>{getProperties({object:this}).find(e=>e.propertyName===t)||Object.defineProperty(this,t,{configurable:!1,get:()=>isNaN(e)?e:Number(e)})}}),this.create({name:"token",value:t});for(const r of getProperties({object:e}))this.create({name:r.propertyName,value:r.propertyValue});for(const a of getProperties({object:s}))this.create({name:a.propertyName,value:a.propertyValue});for(const o of getProperties({object:n}))this.create({name:o.propertyName,value:o.propertyValue})}function MessageQueue({logger:r}){const a={},o=async({binding:t})=>{if(0!==t.callbacks.length&&0!==t.messages.length)if(t.locked)log({logger:r,binding:t,text:"waiting for queue lock"}),setTimeout(()=>o({binding:t}),1e3);else{t.locked=!0;const s=t.callbacks.sort((e,t)=>e.priority-t.priority),n=s.shift();log({logger:r,binding:t,text:`pulling message (1 of ${t.messages.length})`});var e=t.messages.shift()["message"];try{await n.resolve({message:e})}catch(e){log({logger:r,binding:t,text:`callback error: ${e.message}.`})}t.locked=!1,o({binding:t})}},i=async({binding:t})=>{if(0!==t.peekCallbacks.length)if(t.locked)log({logger:r,binding:t,text:"waiting for queue lock"}),setTimeout(()=>i({binding:t}),1e3);else{t.locked=!0,log({logger:r,binding:t,text:`peeking at first message (1 of ${t.messages.length})`});var e=(t.messages[t.messages.length-1]||{message:null})["message"];try{const s=t.peekCallbacks.shift();await s.resolve({message:e})}catch(e){log({logger:r,binding:t,text:`callback error: ${e.message}.`})}t.locked=!1,i({binding:t})}};Object.defineProperty(this,"queueMessage",{configurable:!1,writable:!1,value:async({message:e,queueName:t})=>{var s=utils.generateGUID();const n=a[t];log({logger:r,binding:n,text:`pushing message (1 of ${n.messages.length})`}),n.messages.push({Id:s,queueName:t,message:e}),i({binding:n}),o({binding:n})}}),Object.defineProperty(this,"dequeueMessage",{configurable:!1,writable:!1,value:({queueName:r})=>new Promise(e=>{var t=utils.generateGUID();const s=a[r];var n=s.callbacks.length-1+1;s.callbacks.push({Id:t,queueName:r,resolve:e,priority:n}),o({binding:s})})}),Object.defineProperty(this,"peekMessage",{configurable:!1,writable:!1,value:({queueName:n})=>new Promise(e=>{var t=utils.generateGUID();const s=a[n];s.peekCallbacks.push({Id:t,queueName:n,resolve:e}),i({binding:s})})}),Object.defineProperty(this,"bind",{configurable:!1,writable:!1,value:({scopeId:e,bindingObj:t})=>{const s=e+"_"+t.constructor.name;Object.defineProperty(t,"name",{configurable:!1,writable:!1,value:s}),Object.defineProperty(t,"messages",{configurable:!1,writable:!1,value:[]}),Object.defineProperty(t,"callbacks",{configurable:!1,writable:!1,value:[]}),Object.defineProperty(t,"peekCallbacks",{configurable:!1,writable:!1,value:[]}),Object.defineProperty(t,"queueMessage",{configurable:!1,writable:!0,value:async({message:e})=>{await this.queueMessage({message:e,queueName:s})}}),Object.defineProperty(t,"dequeueMessage",{configurable:!1,writable:!0,value:async()=>this.dequeueMessage({queueName:s})}),Object.defineProperty(t,"peekMessage",{configurable:!1,writable:!0,value:async()=>this.peekMessage({queueName:s})}),Object.defineProperty(t,"unbind",{configurable:!1,writable:!1,value:()=>{Object.defineProperty(t,"queueMessage",{configurable:!1,writable:!0,value:()=>{log({logger:r,binding:t,text:"unbinded and not queueing messages anymore."})}}),Object.defineProperty(t,"dequeueMessage",{configurable:!1,writable:!0,value:()=>new Promise(()=>{log({logger:r,binding:t,text:"unbinded and not dequeueing messages anymore."})})}),Object.defineProperty(t,"peekMessage",{configurable:!1,writable:!0,value:()=>new Promise(()=>{log({logger:r,binding:t,text:"unbinded and not peeking at messages anymore."})})}),this.unbind({queueName:s})}}),a[s]=t}}),Object.defineProperty(this,"unbind",{configurable:!1,writable:!1,value:({queueName:e})=>{delete a[e]}})}function MessageStatus({messageStatusCode:t}){var{code:e,description:s,parent:n}=allMessageStatus.find(e=>e.code===t||e.code===t.toString());this.code=e,this.description=s,this.parent=n?new MessageStatus({messageStatusCode:n.code}):null,Object.defineProperty(this,"match",{configurable:!1,writable:!1,value:({wildcard:e})=>{for(const t of allMessageStatus.filter(e=>e.parent&&e.parent.code===this.code))if(-1<t.description.toLowerCase().indexOf(e))return t;return null}}),Object.defineProperty(this,"root",{configurable:!1,writable:!1,value:()=>{if(null===this.parent)return this;{let e=this.parent,t=null;for(;e;)e=(t=e).parent;return t}}})}function MessageStore(){Object.defineProperty(this,"save",{configurable:!1,writable:!1,value:async({})=>{}}),Object.defineProperty(this,"get",{configurable:!1,writable:!1,value:async({})=>{}})}function RecipientAddress({recipientHost:e,recipientPort:t}){Object.defineProperty(this,"recipientHost",{configurable:!1,writable:!1,value:e}),Object.defineProperty(this,"recipientPort",{configurable:!1,writable:!1,value:t})}function SenderAddress({senderHost:e,senderPort:t}){Object.defineProperty(this,"senderHost",{configurable:!1,writable:!1,value:e}),Object.defineProperty(this,"senderPort",{configurable:!1,writable:!1,value:t})}function ServerMessageBus({httpServerResponseMessageBus:t,httpServerRequestMessageBus:e,messageConverter:s}){Object.defineProperty(this,"publish",{configurable:!1,writable:!1,value:async({message:e})=>{await t.publish(s.convertMessageToHttpResponseMessage({message:e}))}}),Object.defineProperty(this,"subscribe",{configurable:!1,writable:!1,value:({callback:t})=>{e.subscribe({callback:async({httpRequestMessage:e})=>{await t(s.convertHttpRequestMessageToMessage({httpRequestMessage:e}))}})}})}function UserSecurity({userId:n}){let r=null,a,o,i=userIdentities[n],c=null;Object.defineProperty(this,"isRegistered",{configurable:!1,writable:!1,value:()=>void 0!==i}),Object.defineProperty(this,"authenticate",{configurable:!1,writable:!1,value:({secret:e,remoteBase64RSAPublickey:t})=>{c=null;var s,e=utils.hashPassphrase(e,i.hashedPassphraseSalt)["hashedPassphrase"];return e===i.hashedPassphrase&&({privateKey:e,publicKey:s}=utils.generatePublicPrivateKeys(e),a=utils.stringToBase64(e),o=utils.stringToBase64(s),r=t||o,{token:c=utils.stringToBase64(utils.getJSONString({userId:n,base64RSAPublicKey:o}))})}}),Object.defineProperty(this,"isAuthorised",{configurable:!1,writable:!1,value:({token:e})=>utils.isBase64String(a)&&utils.isBase64String(o)&&c===e}),Object.defineProperty(this,"register",{configurable:!1,writable:!1,value:({secret:e})=>{var{hashedPassphrase:e,hashedPassphraseSalt:t}=utils.hashPassphrase(e);i={hashedPassphrase:e,hashedPassphraseSalt:t},userIdentities[n]=i,fs.writeFileSync(userIdentitiesStorePath,JSON.stringify(userIdentities),"utf8")}}),Object.defineProperty(this,"unregister",{configurable:!1,writable:!1,value:()=>{delete userIdentities[n],fs.writeFileSync(userIdentitiesStorePath,JSON.stringify(userIdentities),"utf8")}}),Object.defineProperty(this,"getHashedPassphrase",{configurable:!1,writable:!1,value:()=>i.hashedPassphrase}),Object.defineProperty(this,"getUserId",{configurable:!1,writable:!1,value:()=>n}),Object.defineProperty(this,"getBase64PublicKey",{configurable:!1,writable:!1,value:()=>({base64RSAPublicKey:o})}),Object.defineProperty(this,"getPublicKey",{configurable:!1,writable:!1,value:()=>({publicKey:utils.base64ToString(o)})}),Object.defineProperty(this,"getToken",{configurable:!1,writable:!1,value:()=>({token:c})}),Object.defineProperty(this,"encryptObjectToJSON",{configurable:!1,writable:!1,value:({object:e})=>{e=utils.getJSONString(e)||"{}";return utils.encryptToBase64Str(e,utils.base64ToString(r))}}),Object.defineProperty(this,"decryptJSONToObject",{configurable:!1,writable:!1,value:({encryptedJsonStr:e})=>{var t=this.getHashedPassphrase(),s=utils.base64ToString(a);return utils.getJSONObject(utils.decryptFromBase64Str(e,s,t))}})}function UserSessions({scopeId:s}){const n={};Object.defineProperty(this,"ensureSession",{configurable:!1,writable:!1,value:({userId:e})=>{var t;return n[e]||(t=createUserSecurity({scopeId:s,userId:e})["userSecurity"],n[e]=t),{userSecurity:n[e]}}})}function HttpClientMessageBus({scopeId:t,httpClientRequestMessageQueueBinding:s,httpClientResponseMessageQueueBinding:c,httpClientStartMessageQueueBinding:e,httpClientStartedMessageQueueBinding:n,httpClientStopMessageQueueBinding:r,timeout:u}){const a=async({callback:e})=>{var t=(await s.dequeueMessage())["message"];await e({message:t}),await a({callback:e})};r.dequeueMessage().then(({message:e})=>{e.scopeId!==t?r.queueMessage({message:e}):(s.unbind(),c.unbind())}),e.dequeueMessage().then(async()=>{n.queueMessage({message:{scopeId:t}}),a({callback:({message:e})=>{const t=e;var{recipientHost:e,recipientPort:s}=t.getRecipientAddress(),n=t.getPath(),r=t.getHeaders(),a=t.getMethod(),o=t.getEncryptedContent();const i=http.request({host:e,port:s,path:n,headers:r,method:a});i.setTimeout(u),i.on("response",async e=>{e.setEncoding("utf8"),e.on("error",e=>console.error(e)),e.body="";for await(const t of e)e.body+=t;await c.queueMessage({message:e})}),i.on("error",e=>console.error(e)),i.end(o)}})})}function HttpClientMessageBusManager({scopeId:t,httpClientStartMessageQueueBinding:s,httpClientStartedMessageQueueBinding:e,httpClientStopMessageQueueBinding:n}){e.peekMessage().then(({message:e})=>{e&&n.queueMessage({message:{scopeId:e.scopeId}}),s.queueMessage({message:{scopeId:t}})})}function HttpClientRequestMessageBus({httpClientRequestMessageQueueBinding:t}){Object.defineProperty(this,"publish",{configurable:!1,writable:!1,value:({httpRequestMessage:e})=>{t.queueMessage({message:e})}})}function HttpClientRequestMessageQueueBinding({scopeId:e,messageQueue:t}){t.bind({bindingObj:this,scopeId:e})}function HttpClientResponseMessageBus({httpClientResponseMessageQueueBinding:e}){const u=require("../factory/httpresponsemessage.factory")["createHttpResponseMessage"];Object.defineProperty(this,"subscribe",{configurable:!1,writable:!1,value:({callback:c})=>{e.dequeueMessage().then(async({message:e})=>{var{body:e,statusCode:t,headers:s}=e,{recipienthost:n,recipientport:r,senderhost:a,senderport:o,token:i}=s;await c(u({scopeId:utils.generateGUID(),messageStatusCode:t,Id:null,data:e,recipientHost:n,recipientPort:r,metadata:s,token:i,senderHost:a,senderPort:o})),this.subscribe({callback:c})})}})}function HttpClientResponseMessageQueueBinding({scopeId:e,messageQueue:t}){t.bind({bindingObj:this,scopeId:e})}function HttpClientStartedMessageQueueBinding({scopeId:e,messageQueue:t}){t.bind({bindingObj:this,scopeId:e})}function HttpClientStartMessageQueueBinding({scopeId:e,messageQueue:t}){t.bind({bindingObj:this,scopeId:e})}function HttpClientStopMessageQueueBinding({scopeId:e,messageQueue:t}){t.bind({bindingObj:this,scopeId:e})}function HttpClientStoppedMessageQueueBinding({scopeId:e,messageQueue:t}){t.bind({bindingObj:this,scopeId:e})}function HttpRequestMessage({message:t}){var{senderHost:e,senderPort:s}=t.getSenderAddress(),{recipientHost:n,recipientPort:r}=t.getRecipientAddress();const{path:a,secret:o,token:i}=t.getMessageMetadata();var{contentType:c,contentLength:u}=t.getContentMetadata();const g={"Content-Type":c.description,"Content-Length":u,secret:o,token:i,senderhost:e,senderport:s,recipienthost:n,recipientport:r};Object.defineProperty(this,"getId",{configurable:!1,writable:!1,value:t.getId}),Object.defineProperty(this,"getEncryptedContent",{configurable:!1,writable:!1,value:t.getEncryptedContent}),Object.defineProperty(this,"getDecryptedContent",{configurable:!1,writable:!1,value:t.getDecryptedContent}),Object.defineProperty(this,"getSenderAddress",{configurable:!1,writable:!1,value:t.getSenderAddress}),Object.defineProperty(this,"getRecipientAddress",{configurable:!1,writable:!1,value:t.getRecipientAddress}),Object.defineProperty(this,"getContentMetadata",{configurable:!1,writable:!1,value:t.getContentMetadata}),Object.defineProperty(this,"getMessageMetadata",{configurable:!1,writable:!1,value:t.getMessageMetadata}),Object.defineProperty(this,"getHeaders",{configurable:!1,writable:!1,value:()=>utils.getJSONObject(utils.getJSONString(g))}),Object.defineProperty(this,"getPath",{configurable:!1,writable:!1,value:()=>a}),Object.defineProperty(this,"getMethod",{configurable:!1,writable:!1,value:()=>"POST"}),Object.defineProperty(this,"getMessageStatus",{configurable:!1,writable:!1,value:()=>{const e=t.getMessageStatus();return e.match({wildcard:"http"})}})}function HttpResponseMessage({message:s}){var{senderHost:e,senderPort:t}=s.getSenderAddress(),{recipientHost:n,recipientPort:r}=s.getRecipientAddress(),a=s.getMessageMetadata()["token"],{contentType:o,contentLength:i}=s.getContentMetadata();const c={"Content-Type":o.description,"Content-Length":i,senderhost:e,senderport:t,recipienthost:n,recipientport:r,token:a};Object.defineProperty(this,"getId",{configurable:!1,writable:!1,value:s.getId}),Object.defineProperty(this,"getEncryptedContent",{configurable:!1,writable:!1,value:s.getEncryptedContent}),Object.defineProperty(this,"getDecryptedContent",{configurable:!1,writable:!1,value:s.getDecryptedContent}),Object.defineProperty(this,"getSenderAddress",{configurable:!1,writable:!1,value:s.getSenderAddress}),Object.defineProperty(this,"getRecipientAddress",{configurable:!1,writable:!1,value:s.getRecipientAddress}),Object.defineProperty(this,"getContentMetadata",{configurable:!1,writable:!1,value:s.getContentMetadata}),Object.defineProperty(this,"getMessageMetadata",{configurable:!1,writable:!1,value:s.getMessageMetadata}),Object.defineProperty(this,"getMessageStatus",{configurable:!1,writable:!1,value:s.getMessageStatus}),Object.defineProperty(this,"getHeaders",{configurable:!1,writable:!1,value:()=>utils.getJSONObject(utils.getJSONString(c))}),Object.defineProperty(this,"getStatusCode",{configurable:!1,writable:!1,value:()=>{const e=s.getMessageStatus();var t=e.match({wildcard:"http"})["code"];return t}}),Object.defineProperty(this,"getStatusMessage",{configurable:!1,writable:!1,value:()=>{const e=s.getMessageStatus();var t=e.match({wildcard:"http"})["description"];return t}})}function HttpServerMessageBus({scopeId:r,httpServerRequestMessageQueueBinding:a,httpServerResponseMessageQueueBinding:o,httpServerStartMessageQueueBinding:e,httpServerStartedMessageQueueBinding:i,httpServerStopMessageQueueBinding:c,httpServerStoppedMessageQueueBinding:u,senderAddress:g,logger:p,timeout:d}){e.dequeueMessage().then(()=>{var{senderHost:e,senderPort:t}=g;const s={host:e,port:t},n=http.createServer();n.on("error",t=>{s.host?dns.lookup(s.host,e=>{e?p.log({date:new Date,context:"HttpServer",text:e.message}):p.log({date:new Date,context:"HttpServer",text:t.message})}):p.log({date:new Date,context:"HttpServer",text:"host not specified"})}),n.on("request",async(e,t)=>{e.setTimeout(d),e.on("error",e=>console.error(e)),e.body="";for await(const n of e)e.body+=n;await a.queueMessage({message:e});const s=(await o.dequeueMessage())["message"];t.writeHead(s.getStatusCode(),s.getStatusMessage(),s.getHeaders()).end(s.getEncryptedContent())}),n.on("listening",()=>{p.log({date:new Date,context:"HttpServer",text:"listening on: "+utils.getJSONString(s)}),i.queueMessage({message:{scopeId:r}})}),n.on("close",()=>{p.log({date:new Date,context:"HttpServer",text:"server was stopped"}),a.unbind(),o.unbind(),u.queueMessage({message:{scopeId:r}})}),c.dequeueMessage().then(()=>{n.close()}),n.listen(s)})}function HttpServerMessageBusManager({scopeId:s,httpServerStartMessageQueueBinding:n,httpServerStartedMessageQueueBinding:e,httpServerStopMessageQueueBinding:r,httpServerStoppedMessageQueueBinding:a}){e.peekMessage().then(({message:e})=>{if(e){const t=e;r.queueMessage({message:{scopeId:t.scopeId}}),a.dequeueMessage().then(({message:e})=>{s!==e.scopeId&&t.scopeId===e.scopeId&&n.queueMessage({message:{scopeId:s}})})}else n.queueMessage({message:{scopeId:s}})})}function HttpServerRequestMessageBus({httpServerRequestMessageQueueBinding:e}){const g=require("../factory/httprequestmessage.factory")["createHttpRequestMessage"];Object.defineProperty(this,"subscribe",{configurable:!1,writable:!1,value:({callback:u})=>{e.dequeueMessage().then(async({message:e})=>{var{headers:e,body:t,path:s}=e;const n=e;let{recipienthost:r,recipientport:a,senderhost:o,senderport:i,token:c}=n;a=isNaN(a)?a:Number(a),i=isNaN(i)?i:Number(i),n.recipientport=a,n.senderport=i,n.path=s;await u(g({scopeId:utils.generateGUID(),messageStatusCode:2,Id:null,data:t,recipientHost:r,recipientPort:a,metadata:n,token:c,senderHost:o,senderPort:i})),this.subscribe({callback:u})})}})}function HttpServerRequestMessageQueueBinding({scopeId:e,messageQueue:t}){t.bind({bindingObj:this,scopeId:e})}function HttpServerResponseMessageBus({httpServerResponseMessageQueueBinding:t}){Object.defineProperty(this,"publish",{configurable:!1,writable:!1,value:async({httpResponseMessage:e})=>{await t.queueMessage({message:e})}})}function HttpServerResponseMessageQueueBinding({scopeId:e,messageQueue:t}){t.bind({bindingObj:this,scopeId:e})}function HttpServerStartedMessageQueueBinding({scopeId:e,messageQueue:t}){t.bind({bindingObj:this,scopeId:e})}function HttpServerStartMessageQueueBinding({scopeId:e,messageQueue:t}){t.bind({bindingObj:this,scopeId:e})}function HttpServerStopMessageQueueBinding({scopeId:e,messageQueue:t}){t.bind({bindingObj:this,scopeId:e})}function HttpServerStoppedMessageQueueBinding({scopeId:e,messageQueue:t}){t.bind({bindingObj:this,scopeId:e})}function WebSocketConnection({}){}function WebSocketMessageHandler({}){this.Id=utils.generateGUID()}function WebSocketMessageQueue(){}Factory.prototype.createContainer=function(e){},ClientMessageBus.prototype.publish=async function({}){},ClientMessageBus.prototype.subscribe=function({}){},Component.prototype.initialise=async function({}){},Component.prototype.receive=async function({}){throw new Error("component was not initialised.")},Component.prototype.send=async function({}){throw new Error("component was not initialised.")},ContentType.prototype.name="",ContentType.prototype.description="",Logger.prototype.log=function({}){},Message.prototype.getId=function(){},Message.prototype.getSenderAddress=function(){},Message.prototype.getRecipientAddress=function(){},Message.prototype.getEncryptedContent=function(){},Message.prototype.getDecryptedContent=function(){},Message.prototype.getMessageMetadata=function(){},Message.prototype.getContentMetadata=function(){},Message.prototype.getMessageStatus=function(){},MessageContent.prototype.encryptedData=function(){},MessageContent.prototype.decryptedData=function(){},MessageContentMetadata.prototype.contentType="",MessageContentMetadata.prototype.contentLength=-1,MessageContentMetadata.prototype.isEncrypted="",MessageConverter.prototype.convertMessageToHttpRequestMessage=function({}){},MessageConverter.prototype.convertMessageToHttpResponseMessage=function({}){},MessageConverter.prototype.convertHttpRequestMessageToMessage=function({}){},MessageConverter.prototype.convertHttpResponseMessageToMessage=function({}){},MessageMetadata.prototype.create=function({}){},MessageQueue.prototype.queueMessage=function({}){},MessageQueue.prototype.dequeueMessage=function({}){},MessageQueue.prototype.peekMessage=function({}){},MessageQueue.prototype.bind=function({}){},MessageQueue.prototype.unbind=function({}){},MessageStatus.prototype.match=function({}){},MessageStatus.prototype.root=function(){},MessageStore.prototype.save=async function({}){},MessageStore.prototype.get=async function({}){},ServerMessageBus.prototype.publish=async function({}){},ServerMessageBus.prototype.subscribe=function({}){},UserSecurity.prototype.isRegistered=function(){},UserSecurity.prototype.authenticate=function({}){},UserSecurity.prototype.isAuthorised=function({}){},UserSecurity.prototype.register=function({}){},UserSecurity.prototype.unregister=function(){},UserSecurity.prototype.getHashedPassphrase=function(){},UserSecurity.prototype.getUserId=function(){},UserSecurity.prototype.getBase64KeyPair=function(){},UserSecurity.prototype.getKeyPair=function(){},UserSecurity.prototype.getToken=function(){},UserSecurity.prototype.encryptObjectToJSON=function({}){},UserSecurity.prototype.decryptJSONToObject=function({}){},UserSessions.prototype.ensureSession=function({}){},HttpClientRequestMessageBus.prototype.publish=function({}){},HttpClientResponseMessageBus.prototype.subscribe=function({}){},HttpRequestMessage.prototype.getId=function(){},HttpRequestMessage.prototype.getEncryptedContent=function(){},HttpRequestMessage.prototype.getDecryptedContent=function(){},HttpRequestMessage.prototype.getSenderAddress=function(){},HttpRequestMessage.prototype.getRecipientAddress=function(){},HttpRequestMessage.prototype.getContentMetadata=function(){},HttpRequestMessage.prototype.getMessageMetadata=function(){},HttpRequestMessage.prototype.getHeaders=function(){},HttpRequestMessage.prototype.getPath=function(){},HttpRequestMessage.prototype.getMessageStatus=function(){},HttpRequestMessage.prototype.getMethod=function(){},HttpResponseMessage.prototype.getId=function(){},HttpResponseMessage.prototype.getEncryptedContent=function(){},HttpResponseMessage.prototype.getDecryptedContent=function(){},HttpResponseMessage.prototype.getSenderAddress=function(){},HttpResponseMessage.prototype.getRecipientAddress=function(){},HttpResponseMessage.prototype.getContentMetadata=function(){},HttpResponseMessage.prototype.getMessageMetadata=function(){},HttpResponseMessage.prototype.getHeaders=function(){},HttpResponseMessage.prototype.getMessageStatus=function(){},HttpResponseMessage.prototype.getStatusCode=function(){},HttpResponseMessage.prototype.getStatusMessage=function(){},HttpServerRequestMessageBus.prototype.subscribe=function({}){},HttpServerResponseMessageBus.prototype.publish=async function({}){},WebSocketConnection.prototype.isOpen=function(){},WebSocketConnection.prototype.send=async function(){},WebSocketConnection.prototype.open=function(){};